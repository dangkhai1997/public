<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Auto Tab Opener</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    label, select, input {
      display: block;
      margin-top: 10px;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>Mở và đóng bài viết WordPress</h2>

  <label for="siteSelect">Chọn trang:</label>
  <select id="siteSelect">
    <option value="https://nieuws.intelnestle.com">nieuws.intelnestle.com</option>
    <option value="https://news.fusiondigest.com">news.fusiondigest.com</option>
    <option value="https://sportnieuws.fusiondigest.com">sportnieuws.fusiondigest.com</option>
  </select>

  <label for="searchString">Chuỗi URL cần chứa (searchString):</label>
  <input type="text" id="searchString" value="dk74" />

  <label for="delayTime">Thời gian chờ (giây):</label>
  <input type="number" id="delayTime" value="5" min="1" />

  <button id="loadPosts">Tải danh sách bài</button>
  <button id="start">Mở từng bài & tự đóng</button>

  <p id="status"></p>

  <script>
    let filteredPosts = [];
    let currentIndex = 0;

    document.getElementById('loadPosts').onclick = async function () {
      const site = document.getElementById('siteSelect').value;
      const search = document.getElementById('searchString').value;
      const status = document.getElementById('status');
      filteredPosts = [];
      currentIndex = 0;
      status.textContent = "Đang tải bài viết...";

      let allPosts = [];
      let page = 1;
      const perPage = 100;

      try {
        while (true) {
          const res = await fetch(`${site}/wp-json/wp/v2/posts?per_page=${perPage}&page=${page}`);
          if (!res.ok) break;
          const posts = await res.json();
          if (posts.length === 0) break;
          allPosts = allPosts.concat(posts);
          page++;
        }

        filteredPosts = allPosts.filter(post => post.link.includes(search));
        status.textContent = `Tìm được ${filteredPosts.length} bài phù hợp. Bấm "Mở từng bài & tự đóng" để bắt đầu.`;

      } catch (e) {
        status.textContent = "Lỗi khi lấy bài viết: " + e.message;
      }
    };

    document.getElementById('start').onclick = function () {
      const delay = parseInt(document.getElementById('delayTime').value) * 1000;
      const status = document.getElementById('status');

      if (filteredPosts.length === 0) {
        status.textContent = "Chưa có bài viết nào để mở.";
        return;
      }

      if (currentIndex >= filteredPosts.length) {
        status.textContent = "Đã hoàn thành tất cả bài viết.";
        return;
      }

      const post = filteredPosts[currentIndex];
      const tab = window.open(post.link, '_blank');

      status.textContent = `Đang mở bài ${currentIndex + 1}/${filteredPosts.length}: ${post.link}`;

      setTimeout(() => {
        try {
          tab.close();
          status.textContent = `Đã đóng bài ${currentIndex + 1}. Bấm lại để tiếp tục.`;
          currentIndex++;
        } catch (e) {
          status.textContent = "Không thể tự đóng tab. Đóng thủ công.";
        }
      }, delay);
    };
  </script>
</body>
</html>
